{% extends "base.html" %}
{% load static %}

{% block title %}Public Interview Questions - STAR Master{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container mx-auto px-4 py-8">
  <!-- Header Section -->
  <div class="mb-8">
    <h1 class="text-4xl font-bold text-base-content mb-4">
      <i class="fas fa-globe text-primary mr-3"></i>
      Public Interview Questions
    </h1>
    <p class="text-lg text-base-content/70 max-w-3xl">
      Browse our collection of curated interview questions. Save any question to your personal collection 
      to practice your responses using the STAR method (Situation, Task, Action, Result).
    </p>
  </div>

  <!-- Info Alert -->
  <div class="alert alert-info mb-8">
    <i class="fas fa-info-circle"></i>
    <div>
      <h3 class="font-bold">How it works</h3>
      <div class="text-sm">
        These are example questions curated by our community. Click "Save" to add any question to your personal collection, 
        where you can then create and practice your own answers.
      </div>
    </div>
  </div>

  <!-- Stats Section -->
  {% if questions %}
  <div class="stats shadow mb-8 w-full">
    <div class="stat">
      <div class="stat-figure text-primary">
        <i class="fas fa-globe text-3xl"></i>
      </div>
      <div class="stat-title">Public Questions</div>
      <div class="stat-value text-primary">{{ page_obj.paginator.count }}</div>
      <div class="stat-desc">Available to save</div>
    </div>
  </div>
  {% endif %}

  <!-- Questions Grid -->
  {% if questions %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
      {% for question in questions %}
        <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-300">
          <div class="card-body">
            <!-- Question Header -->
            <div class="flex items-start justify-between mb-3">
              <div class="badge badge-success badge-sm">
                <i class="fas fa-check mr-1"></i>
                Public
              </div>
              {% if question.tags.all %}
                <div class="flex flex-wrap gap-1">
                  {% for tag in question.tags.all|slice:":2" %}
                    <div class="badge badge-outline badge-xs">{{ tag.name }}</div>
                  {% endfor %}
                  {% if question.tags.count > 2 %}
                    <div class="badge badge-outline badge-xs">+{{ question.tags.count|add:"-2" }}</div>
                  {% endif %}
                </div>
              {% endif %}
            </div>

            <!-- Question Title -->
            <h3 class="card-title text-base mb-2 line-clamp-2">
              {{ question.title }}
            </h3>

            <!-- Question Body Preview -->
            {% if question.body %}
              <p class="text-sm text-base-content/70 mb-4 line-clamp-3">
                {{ question.body|truncatewords:20 }}
              </p>
            {% endif %}

            <!-- Question Meta -->
            <div class="flex items-center justify-between text-xs text-base-content/60 mb-4">
              <span>
                <i class="fas fa-user mr-1"></i>
                {{ question.owner.username }}
              </span>
              <span>
                <i class="fas fa-calendar mr-1"></i>
                {{ question.created_at|date:"M d, Y" }}
              </span>
            </div>

            <!-- Community Stats -->
            <div class="flex items-center justify-between text-xs text-base-content/60 mb-4">
              <span>
                <i class="fas fa-eye mr-1"></i>
                Example question
              </span>
              {% if question.votes.all %}
                <span>
                  <i class="fas fa-star mr-1"></i>
                  {{ question.votes.all|length }} rating{{ question.votes.all|length|pluralize }}
                </span>
              {% endif %}
            </div>

            <!-- Actions -->
            <div class="card-actions justify-end">
              <a href="{% url 'questions:detail' pk=question.pk %}" class="btn btn-outline btn-sm">
                <i class="fas fa-eye mr-1"></i>
                View
              </a>
              {% if user.is_authenticated %}
                {% if question.title in saved_question_titles %}
                  <button class="btn btn-success btn-sm" disabled>
                    <i class="fas fa-check mr-1"></i>
                    Saved
                  </button>
                {% else %}
                  <button 
                    class="btn btn-primary btn-sm save-question-btn" 
                    data-question-id="{{ question.id }}"
                    data-question-title="{{ question.title }}"
                  >
                    <i class="fas fa-bookmark mr-1"></i>
                    Save
                  </button>
                {% endif %}
              {% else %}
                <div class="tooltip" data-tip="Sign in to save questions">
                  <button class="btn btn-primary btn-sm btn-disabled">
                    <i class="fas fa-bookmark mr-1"></i>
                    Save
                  </button>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.paginator.num_pages > 1 %}
      <div class="flex justify-center">
        <div class="join">
          {% if page_obj.has_previous %}
            <a href="?page=1" class="join-item btn btn-sm">
              <i class="fas fa-angle-double-left"></i>
            </a>
            <a href="?page={{ page_obj.previous_page_number }}" class="join-item btn btn-sm">
              <i class="fas fa-angle-left"></i>
            </a>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <span class="join-item btn btn-sm btn-active">{{ num }}</span>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <a href="?page={{ num }}" class="join-item btn btn-sm">{{ num }}</a>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="join-item btn btn-sm">
              <i class="fas fa-angle-right"></i>
            </a>
            <a href="?page={{ page_obj.paginator.num_pages }}" class="join-item btn btn-sm">
              <i class="fas fa-angle-double-right"></i>
            </a>
          {% endif %}
        </div>
      </div>
    {% endif %}

  {% else %}
    <!-- Empty State -->
    <div class="hero bg-base-200 rounded-3xl">
      <div class="hero-content text-center py-12">
        <div class="max-w-md">
          <i class="fas fa-globe text-6xl text-base-content/30 mb-6"></i>
          <h2 class="text-2xl font-bold mb-4 text-base-content">No Public Questions Available</h2>
          <p class="text-base-content/70 mb-6">
            There are no approved public questions available at the moment. Check back later for new examples!
          </p>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<!-- Toast Container for Messages -->
<div id="toast-container" class="toast toast-end">
</div>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const saveButtons = document.querySelectorAll('.save-question-btn');
    
    saveButtons.forEach(button => {
        button.addEventListener('click', async function() {
            const questionId = this.dataset.questionId;
            const questionTitle = this.dataset.questionTitle;
            const originalHTML = this.innerHTML;
            
            // Show loading state
            this.innerHTML = '<span class="loading loading-spinner loading-xs"></span> Saving...';
            this.disabled = true;
            
            try {
                const response = await fetch(`/questions/save/${questionId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                    },
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Show success state
                    this.innerHTML = '<i class="fas fa-check mr-1"></i> Saved!';
                    this.classList.remove('btn-primary');
                    this.classList.add('btn-success');
                    
                    // Show toast notification
                    showToast('success', `"${questionTitle}" saved to your collection!`);
                    
                    // Update all buttons for questions with the same title
                    const allButtonsForThisTitle = document.querySelectorAll(`[data-question-title="${questionTitle}"]`);
                    allButtonsForThisTitle.forEach(btn => {
                        btn.innerHTML = '<i class="fas fa-check mr-1"></i> Saved';
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-success');
                        btn.disabled = true;
                    });
                    
                } else {
                    throw new Error(data.error || 'Failed to save question');
                }
                
            } catch (error) {
                // Show error state
                this.innerHTML = originalHTML;
                this.disabled = false;
                showToast('error', error.message || 'Failed to save question. Please try again.');
            }
        });
    });
    
    function showToast(type, message) {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        
        const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
        const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
        
        toast.className = `alert ${alertClass} mb-2`;
        toast.innerHTML = `
            <i class="${icon}"></i>
            <span>${message}</span>
        `;
        
        toastContainer.appendChild(toast);
        
        // Remove toast after 5 seconds
        setTimeout(() => {
            toast.remove();
        }, 5000);
    }
});
</script>
{% endblock %}
